const backendUrl = import.meta.env.VITE_BACKEND_URL;

// Debug: verificar la URL del backend
console.log("üîç Backend URL:", backendUrl);

/**
 * Funci√≥n para decodificar y verificar el token JWT
 */
const decodeJWT = (token) => {
    try {
        // Un JWT tiene 3 partes separadas por puntos: header.payload.signature
        const parts = token.split('.');
        if (parts.length !== 3) {
            throw new Error("Token JWT inv√°lido: no tiene 3 partes");
        }
        
        const payload = JSON.parse(atob(parts[1]));
        console.log("Token payload:", payload);
        return payload;
    } catch (error) {
        console.error("Error decodificando token:", error);
        return null;
    }
};

export const actions = (dispatch) => ({

    login: (email, password) => {
        const opts = {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({ email, password }),
        };

        // ‚úÖ URL CORREGIDA - con slash antes de api
        const loginUrl = `${backendUrl}/api/token`;
        console.log("üåê Making login request to:", loginUrl);

        return fetch(loginUrl, opts)
            .then(async (resp) => {
                const responseText = await resp.text();
                console.log("üìä Login response status:", resp.status);
                console.log("üìã Login response text:", responseText);
                
                if (resp.status === 401) {
                    throw new Error("Credenciales inv√°lidas");
                }
                if (resp.status === 422) {
                    throw new Error("Datos de formulario inv√°lidos");
                }
                if (resp.status === 400) {
                    throw new Error("Solicitud mal formada");
                }
                if (!resp.ok) {
                    throw new Error(`Error en la autenticaci√≥n: ${resp.status} - ${responseText}`);
                }

                try {
                    const data = JSON.parse(responseText);
                    console.log("‚úÖ Login successful - Response data:", data);
                    return data;
                } catch (e) {
                    console.error("‚ùå Error parsing login response:", e);
                    throw new Error("Respuesta del servidor no v√°lida");
                }
            })
            .then(data => {
                if (!data.access_token) {
                    console.error("‚ùå No access_token in response:", data);
                    throw new Error("Token no recibido del servidor");
                }
                
                // Debug del token
                console.log("üîë Token recibido:", data.access_token);
                const tokenPayload = decodeJWT(data.access_token);
                
                if (!tokenPayload) {
                    throw new Error("Token JWT inv√°lido: no se pudo decodificar");
                }
                
                // ACEPTAR tanto n√∫meros como strings en el sub
                if (tokenPayload.sub === undefined || tokenPayload.sub === null) {
                    console.error("‚ùå Token inv√°lido: subject no definido");
                    throw new Error("Token inv√°lido: subject no definido");
                }
                
                // Convertir sub a string si es n√∫mero (para compatibilidad)
                if (typeof tokenPayload.sub === 'number') {
                    console.log("üî¢ Converting numeric sub to string:", tokenPayload.sub);
                    tokenPayload.sub = tokenPayload.sub.toString();
                }
                
                // Guardar en localStorage para persistencia
                localStorage.setItem("token", data.access_token);
                console.log("üíæ Token guardado en localStorage");
                
                dispatch({ type: 'LOGIN_SUCCESS', payload: data.access_token });
                return true;
            })
            .catch(error => {
                console.error("‚ùå Error durante el login:", error.message);
                dispatch({ type: 'LOGIN_ERROR', payload: error.message });
                return false;
            });
    },

    signup: (userData) => {
        const opts = {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(userData),
        };

        // ‚úÖ URL CORREGIDA - con slash antes de api
        const signupUrl = `${backendUrl}/api/user`;
        console.log("üåê Making signup request to:", signupUrl);

        return fetch(signupUrl, opts)
            .then(async (resp) => {
                const responseText = await resp.text();
                console.log("üìä Signup response status:", resp.status);
                console.log("üìã Signup response text:", responseText);
                
                if (resp.status === 422) {
                    let errorMessage = "Error de validaci√≥n en el registro";
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.detail || errorData.error || errorData.msg || errorMessage;
                    } catch (e) {
                        errorMessage = responseText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                if (resp.status === 400) {
                    throw new Error("Datos de registro inv√°lidos");
                }
                
                if (resp.status === 409) {
                    throw new Error("El usuario ya existe");
                }
                
                if (!resp.ok) {
                    throw new Error(`Error en el registro: ${resp.status} - ${responseText}`);
                }

                try {
                    return JSON.parse(responseText);
                } catch (e) {
                    throw new Error("Respuesta del servidor no v√°lida");
                }
            })
            .then(data => {
                console.log("‚úÖ Signup successful, attempting login...");
                return actions(dispatch).login(userData.email, userData.password);
            })
            .catch(error => {
                console.error("‚ùå Error durante el registro:", error.message);
                dispatch({ type: 'SIGNUP_ERROR', payload: error.message });
                throw error;
            });
    },

    logout: () => {
        console.log("üö™ Logging out...");
        localStorage.removeItem("token");
        sessionStorage.removeItem("token");
        console.log("üóëÔ∏è Tokens removidos de storage");
        dispatch({ type: 'LOGOUT' });
    },
    
    getUser: (token) => {
        if (!token) {
            console.error("‚ùå No token provided for getUser");
            dispatch({ type: 'AUTH_ERROR', payload: "Token no proporcionado" });
            return false;
        }

        // Debug: inspeccionar el token
        console.log("üîç Token para getUser:", token);
        const tokenPayload = decodeJWT(token);
        
        if (!tokenPayload) {
            console.error("‚ùå Token inv√°lido: no se pudo decodificar");
            localStorage.removeItem("token");
            sessionStorage.removeItem("token");
            dispatch({ type: 'LOGOUT' });
            return false;
        }

        if (tokenPayload.sub === undefined || tokenPayload.sub === null) {
            console.error("‚ùå Token inv√°lido: falta subject (sub)");
            localStorage.removeItem("token");
            sessionStorage.removeItem("token");
            dispatch({ type: 'LOGOUT' });
            return false;
        }

        // ACEPTAR tanto n√∫meros como strings en el sub
        if (typeof tokenPayload.sub === 'number') {
            console.log("üî¢ Numeric sub detected in profile request:", tokenPayload.sub);
        }

        const opts = {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
        };

        // ‚úÖ URL CORREGIDA - con slash antes de api
        const profileUrl = `${backendUrl}/api/profile`;
        console.log("üåê Making profile request to:", profileUrl);

        return fetch(profileUrl, opts)
            .then(async (resp) => {
                const responseText = await resp.text();
                
                console.log(`üìä Profile response status: ${resp.status}`);
                console.log(`üìã Profile response text: ${responseText}`);

                if (resp.status === 401) {
                    console.warn("‚ö†Ô∏è Unauthorized - removing token");
                    localStorage.removeItem("token");
                    sessionStorage.removeItem("token");
                    dispatch({ type: 'LOGOUT' });
                    throw new Error("No autorizado - Sesi√≥n expirada");
                }
                
                if (resp.status === 422) {
                    console.warn("‚ö†Ô∏è Unprocessable Entity - removing token");
                    localStorage.removeItem("token");
                    sessionStorage.removeItem("token");
                    dispatch({ type: 'LOGOUT' });
                    
                    let errorDetail = "Token inv√°lido o expirado";
                    try {
                        const errorData = JSON.parse(responseText);
                        errorDetail = errorData.msg || errorData.detail || errorData.error || errorDetail;
                    } catch (e) {
                        // Mantener el mensaje por defecto
                    }
                    throw new Error(errorDetail);
                }
                
                if (resp.status === 404) {
                    throw new Error("Perfil no encontrado");
                }
                
                if (!resp.ok) {
                    throw new Error(`Error del servidor: ${resp.status} - ${responseText}`);
                }

                try {
                    const data = JSON.parse(responseText);
                    console.log("‚úÖ Profile data received successfully:", data);
                    return data;
                } catch (e) {
                    console.error("‚ùå Error parsing profile response:", e);
                    throw new Error("Respuesta del servidor no v√°lida");
                }
            })
            .then(data => {
                dispatch({ type: 'SET_USER', payload: data });
                console.log("‚úÖ Profile data set successfully");
                return true;
            })
            .catch(error => {
                console.error("‚ùå Error fetching user data:", error.message);
                dispatch({ type: 'PROFILE_ERROR', payload: error.message });
                return false;
            });
    },

    /**
     * Funci√≥n para verificar y renovar token si es necesario
     */
    verifyToken: (token) => {
        console.log("üîç Verifying token...");
        return actions(dispatch).getUser(token);
    }
});

